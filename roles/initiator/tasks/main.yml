---
- name: initiator | Install initiator packages
  dnf:
      state: latest
      name: "{{ item }}"
  with_items:
  - iscsi-initiator-utils
  become: yes
  become_user: root

- name: Copy a new initiatorname.iscsi file | back up original
  template:
    src: initiatorname.j2
    dest: /etc/iscsi/initiatorname.iscsi
    owner: root
    group: root
    mode: 0644
    backup: yes    
  notify: restart_iscsi
  become: yes
  become_user: root

- name: Create the mountpoint 
  file:
    path: /opt/Backups
    state: directory
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: 0755
  become: yes
  become_user: root

- name: disover targets
  open_iscsi:
    show_nodes: yes
    discover: yes
    portal: "{{ iscsi_target_ip }}"
  become: yes
  become_user: root
  
- name: login to target
  open_iscsi:
    login: yes
    target: "iqn.2018-05.local.c7-server:{{ iscsi_client_name }}"
    portal: "{{ iscsi_target_ip }}"
  register: returned_device
  debug: 
    msg: "device is {{ returned_device.devicenode }}"
  notify: partition_and_mount

  

